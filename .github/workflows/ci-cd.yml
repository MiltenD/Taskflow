name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v --tb=short
  
  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t taskflow-app:latest .
        echo "âœ… Docker image built successfully"
    
    - name: Test Docker image
      run: |
        echo "Testing Docker image..."
        docker run --rm -d -p 5000:5000 --name test-container taskflow-app:latest
        sleep 5
        docker logs test-container || true
        docker stop test-container
        echo "âœ… Docker test completed"
  
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deployment Simulation
      run: |
        echo "ðŸš€ SIMULATING PRODUCTION DEPLOYMENT"
        echo "====================================="
        echo "Application: TaskFlow"
        echo "Commit SHA: ${{ github.sha }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo ""
        echo "Simulated Steps:"
        echo "1. âœ… Image built and tested"
        echo "2. âœ… Database migrations ready"
        echo "3. âœ… Health checks passing"
        echo "4. âœ… Load balancer updated"
        echo "5. âœ… Deployment successful"
        echo ""
        echo "ðŸ“Š Ready for real deployment to:"
        echo "   - VPS (DigitalOcean/AWS)"
        echo "   - Docker Swarm / Kubernetes"
        echo "   - Cloud platform"